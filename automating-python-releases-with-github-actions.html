<main>
    <p>Oh yes. I'm lazy.</p>
<p>Haven't we established that, yet? Well, we're going to hit that nail home with this topic...</p>
<p>We've established previously that I manage a number of random Python packages, including <em>ElectricPy</em>, <em>SELProtoPy</em>, and <em>PyCEV</em>.
I've come to the realization that I need all the help I can get with releasing updates on a regular basis. So... How shall we do
that?</p>
<h3>Where to Start?</h3>
<p>I decided that I needed this for <em>ElectricPy</em> first. So let's start with figuring out what we want to do:</p>
<ul>
<li>Identify the Current ElectricPy Version from the Source Code (bail out if the version is the same or older than what's previously been released)</li>
<li>Create a Tag that Matches the ElectricPy Version, then Push that to GitHub</li>
<li>Build the Python Package as a Source-Code Bundle, and as a <a href="https://pythonwheels.com">Python Wheel</a></li>
<li>Push the Packages to the Python Package Index (PyPI)</li>
</ul>
<p>So those are the primary requirements. Now, let's work out how we're going to do it. I know that I want to use GitHub actions to
do this whole thing. So let's start there.</p>
<h3>What are GitHub Actions, Anyway?</h3>
<p>Well, GitHub actions are GitHub's way of providing CI/CD systems. Essentially, providing Linux-container based workflows that are
defined through YAML description files. The YAML (which stands for Yet Another Mark-up Language) files define what container base
should be used, and what the steps need to be completed.</p>
<h3>Are there any Read-to-Go GitHub Actions?</h3>
<p>Well, yes... But, actually no.</p>
<p>There's quite a few pretty good actions available in the community, but getting everything <em>just</em> right is a bit more tricky. Why, you
ask? Well, they all completed one or two of those actions I'd outlined above, but they didn't cover the whole list. So, I decided to
glue them all together with a bit of Python!</p>
<h3>Start by Identifying the Version</h3>
<p>We need to pick the version out of the ElectricPy package, and then we need to double-check that it's not already used, or older than
the most-up-to-date version. So I built a simple little script:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Release Versioning Support Script</span>
<span class="c1"># Joe Stanley | 2021</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;engineerjoe440&#39;</span>
<span class="n">REPO</span> <span class="o">=</span> <span class="s1">&#39;electricpy&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">electricpy</span> <span class="k">as</span> <span class="nn">ep</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="kn">import</span> <span class="nn">electricpy</span> <span class="k">as</span> <span class="nn">ep</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://api.github.com/repos/</span><span class="si">{</span><span class="n">USERNAME</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">REPO</span><span class="si">}</span><span class="s2">/releases/latest&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>

<span class="c1"># Verify Version is Newer</span>
<span class="n">version</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">ep</span><span class="o">.</span><span class="n">_version_</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="n">version</span> <span class="o">&lt;=</span> <span class="n">latest</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Module version is not newer than previous release!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</code></pre></div>

<p>So, that script does a couple things for us. It polls GitHub for the latest release marked in the repo under my
username and project name. It then verifies that the version is valid and <em>new</em>.</p>
<h3>How About that Action Definition?</h3>
<p>So, we've covered one of the four pieces we need to accomplish. What's left? Well, we still need to build the
Python package (but that's easy) and then create the release and push it to PyPI. Lucky for us, both of those
remaining "questions" there's ready-made GitHub actions! So what does this whole thing look like?</p>
<div class="highlight"><pre><span></span><code><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Release</span>
<span class="n">on</span><span class="o">:</span>
<span class="w">  </span><span class="n">push</span><span class="o">:</span>
<span class="w">   </span><span class="n">branches</span><span class="o">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">master</span>

<span class="n">jobs</span><span class="o">:</span>
<span class="w">  </span><span class="n">release</span><span class="o">:</span>
<span class="w">    </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="o">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span>
<span class="w">    </span><span class="n">steps</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v2</span>
<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/marketplace/actions/s</span><span class="n">etup</span><span class="o">-</span><span class="n">python</span>
<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="o">^--</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">gives</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="n">testing</span><span class="o">.</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">Python</span>
<span class="w">        </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">setup</span><span class="o">-</span><span class="n">python</span><span class="err">@</span><span class="n">v1</span>
<span class="w">        </span><span class="k">with</span><span class="o">:</span>
<span class="w">          </span><span class="n">python</span><span class="o">-</span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;3.10&quot;</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Identify</span><span class="w"> </span><span class="n">Version</span>
<span class="w">        </span><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="n">version</span>
<span class="w">        </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">user</span>
<span class="w">          </span><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="n">requirements</span><span class="o">.</span><span class="na">txt</span><span class="w"> </span><span class="o">--</span><span class="n">user</span>
<span class="w">          </span><span class="n">output</span><span class="o">=</span><span class="n">$</span><span class="o">(</span><span class="n">python</span><span class="w"> </span><span class="n">release</span><span class="o">-</span><span class="n">version</span><span class="o">.</span><span class="na">py</span><span class="o">)</span>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;::set-output name=version::$output&quot;</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">Artifacts</span>
<span class="w">        </span><span class="k">if</span><span class="o">:</span><span class="w"> </span><span class="n">success</span><span class="o">()</span>
<span class="w">        </span><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="n">build</span>
<span class="w">        </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">sdist</span><span class="w"> </span><span class="o">--</span><span class="n">wheel</span><span class="w"> </span><span class="o">--</span><span class="n">outdir</span><span class="w"> </span><span class="n">dist</span><span class="o">/</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">Release</span>
<span class="w">        </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">ncipollo</span><span class="o">/</span><span class="n">release</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">v1</span>
<span class="w">        </span><span class="k">with</span><span class="o">:</span>
<span class="w">          </span><span class="n">tag</span><span class="o">:</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">steps</span><span class="o">.</span><span class="na">version</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">version</span><span class="w"> </span><span class="o">}}</span>
<span class="w">          </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Release</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">steps</span><span class="o">.</span><span class="na">version</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">version</span><span class="w"> </span><span class="o">}}</span>
<span class="w">          </span><span class="n">body</span><span class="o">:</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">steps</span><span class="o">.</span><span class="na">tag_version</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">changelog</span><span class="w"> </span><span class="o">}}</span>
<span class="w">          </span><span class="n">artifacts</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;dist/*&quot;</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Publish</span><span class="w"> </span><span class="n">distribution</span><span class="w"> </span><span class="err">📦</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">PyPI</span>
<span class="w">        </span><span class="k">if</span><span class="o">:</span><span class="w"> </span><span class="n">success</span><span class="o">()</span>
<span class="w">        </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">pypa</span><span class="o">/</span><span class="n">gh</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">pypi</span><span class="o">-</span><span class="n">publish</span><span class="err">@</span><span class="n">master</span>
<span class="w">        </span><span class="k">with</span><span class="o">:</span>
<span class="w">            </span><span class="n">password</span><span class="o">:</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">PYPI_API_TOKEN</span><span class="w"> </span><span class="o">}}</span>
</code></pre></div>

<p>That big definition basically does a bunch of stuff for us; I'll break it out by each of the steps:</p>
<ol>
<li>Check out the source code.</li>
<li>Install Python 3.10 - Because we kinda need that. Notice here that <code>3.10</code> is in double quotes as: "3.10".
That's because otherwise, the GitHub system might mistake it as 3.1... You know, because 3.10 is really just
a decimal number with an extra 0 at the end.</li>
<li>Use the Python Script (from above) to figure out the version. But not before installing the required
packages; both for the script, and for <em>ElectricPy</em>.</li>
<li>Build the Artifacts - The things we want to keep. Namely the source-code distribution (<code>--sdist</code>) and the
wheel file.</li>
<li>Create the GitHub release. This will place the package on the GitHub repo's "Releases" page and add a new
tag to the repository so it's easy to back-track the code.</li>
<li>Finally, push those artifacts to PyPI so they're available for download and install with <code>pip</code>.</li>
</ol>
<h3>Wrapping Up</h3>
<p>This might not be the biggest accomplishment, but it's a huge relief because it makes automating releases
and pushing out updates MUCH easier. So, let's bring on the new features and updates!!!</p>
</main>